# Combining trait, weather, and image datasets

The objective of this vignette is to walk through how to combine our several types of data, and demonstrate several realistic analyses that can be done on these merged data. 

For the first analysis, we want to figure out how the number of sufficiently warm days affects the amount of canopy cover at our site. We do this by combining the canopy cover data with the meteorological data on growing degree days, then modeling and plotting their relationship. We are specifically interested in figuring out when the increase in canopy cover starts to slow down in response to warm temperature days. 

The second analysis compares greenness from image data with canopy cover. 

## Get and join data

Here we combine two dataframes. 
The first contains all the canopy height values for 2017, which was created in the traits vignette. 
The second is the cumulative growing degree days for all of 2017, which were calculated from the daily minimum and maximum temperatures in the weather vignette. 
They are combined by their common column, the date. 

```{r synth_setup}
library(dplyr)
library(ggplot2)
library(jsonlite)
library(lubridate)
library(traits)
library(inflection)

options(betydb_url = "https://terraref.ncsa.illinois.edu/bety/",
        betydb_api_version = 'v1', 
        betydb_key = '9999999999999999999999999999999999999999')
```

```{r get_trait_data, message = FALSE}
trait <- betydb_query(table     = "search", 
                      trait     = "canopy_height", 
                      date      = "~2017",
                      limit     =  "none")

trait = trait %>% 
  mutate(day = as.Date(raw_date))
```

```{r get_weather_data}
weather <- fromJSON('https://terraref.ncsa.illinois.edu/clowder/api/geostreams/datapoints?stream_id=46431&since=2017-01-01&until=2017-12-31', flatten = FALSE)

weather <- weather$properties %>% 
  mutate(time = ymd_hms(weather$end_time))

daily_values = weather %>% 
  mutate(day = as.Date(time), 
         air_temp_converted = air_temperature - 273.15) %>% 
  group_by(day) %>% 
  summarise(min_temp = min(air_temp_converted), 
            max_temp = max(air_temp_converted), 
            gdd = ifelse(sum(min_temp, max_temp) / 2 > 10, 
                         (max_temp + min_temp) / 2 - 10, 0))

daily_values = daily_values %>% 
  mutate(gdd_cum = cumsum(gdd))
```

```{r combine_trait_weather}
trait_weather_df = full_join(trait, daily_values, by = "day")
trait_weather_df = trait_weather_df %>% 
  select(day, cultivar, mean, gdd_cum) %>% 
  na.omit()
```

## Plot and model relationship between GDD and canopy cover for each cultivar

We are interested in how growing degree days affects canopy cover. 
To investigate this, we are going to model and plot their relationship. 
We want to know the relationship for each cultivar, so we'll start of by determining the parameters of the model for one of the cultivars in our dataset. 
We are using a logistic growth model here because it is appropriate for the shape of the GDD-cover relationship. 

```{r model_get_parameters}
single_cultivar = trait_weather_df %>% 
  filter(cultivar == "PI656026")

cap = 120
initial = 25
mean = single_cultivar$mean[57]
gdd_cum = single_cultivar$gdd_cum[57]
rate = ((log((cap/mean) - 1)) - initial)/gdd_cum

model_single_cultivar = nls(mean ~ cap / (1 + exp(initial + rate * gdd_cum)), 
                            start = list(cap = 120, initial = 25, rate = rate),
                            data = single_cultivar, trace = TRUE)

single_cultivar = single_cultivar %>% 
  mutate(mean_predict = coef(model_single_cultivar)[1] / (1 + exp(coef(model_single_cultivar)[2] + coef(model_single_cultivar)[3] * gdd_cum)))
```

We then use the parameters from a single cultivar to run a model for each of the rest of the cultivars. 
These results are used to plot the model predictions, which are shown as an orange line. 

```{r model_all_cultivars}
all_cultivars = c(day = as.double(), cultivar = as.character(), mean = as.numeric(), 
                  gdd_cum = as.numeric(), mean_predict = as.numeric())
for(each_cultivar in unique(trait_weather_df$cultivar)){
  each_cultivar_df = filter(trait_weather_df, cultivar == each_cultivar)
  each_cultivar_model = nls(mean ~ cap / (1 + exp(initial + rate * gdd_cum)), 
                            start = list(cap = 120, initial = 25, rate = rate),
                            data = each_cultivar_df)
  each_cultivar_df = each_cultivar_df %>% 
      mutate(mean_predict = coef(each_cultivar_model)[1] / (1 + exp(coef(each_cultivar_model)[2] + coef(each_cultivar_model)[3] * gdd_cum)))
  all_cultivars = rbind(each_cultivar_df, all_cultivars)
}

ggplot(all_cultivars) +
  geom_point(aes(x = gdd_cum, y = mean)) +
  geom_line(aes(x = gdd_cum, y = mean_predict), color = "orange") +
  facet_wrap(~cultivar, scales = "free_y") +
  labs(x = "Cumulative growing degree days", y = "Canopy Height")
```

## Create histogram of growth rate for all cultivars

The last thing that we are going to do is assess the difference in this relationship among the cultivars. 
We are going to use the inflection point from the logistic growth model, which indicates when canopy cover stops increasing as quickly with increasingly more warm days. 
The `inflection` R package is used for the calculation. 
The resulting inflection points for each cultivar are plotted as a histogram. 

```{r calculate_inflections}
inflection_points = c(cultivar = as.character(), value = as.numeric())
for(each_cultivar in unique(all_cultivars$cultivar)){
  each_cultivar_df = filter(all_cultivars, cultivar == each_cultivar)
  each_cultivar_inf = ede(each_cultivar_df$gdd_cum, each_cultivar_df$mean_predict, 0)
  each_cultivar_df = data.frame(cultivar = each_cultivar, inf_value = each_cultivar_inf[3])
  inflection_points = rbind(each_cultivar_df, inflection_points)
}

all_cultivars = left_join(all_cultivars, inflection_points, by = "cultivar")
```

```{r plot_inflections}
ggplot(all_cultivars) +
  geom_point(aes(x = gdd_cum, y = mean)) +
  geom_line(aes(x = gdd_cum, y = mean_predict), color = "orange") +
  geom_vline(aes(xintercept = inf_value)) +
  facet_wrap(~cultivar, scales = "free_y") +
  labs(x = "Cumulative growing degree days", y = "Canopy Height")

ggplot(inflection_points, aes(x = inf_value)) +
  geom_histogram() +
  xlim(min(all_cultivars$gdd_cum), max(all_cultivars$gdd_cum)) +
  labs(x = "Inflection points", y = "Number")
```

## Get image data
```{r get_image_data}
library(raster)
library(rgdal)
library(stringr)

# File downloaded from : https://terraref.ncsa.illinois.edu/clowder/datasets/5c507cb74f0c436195ba8eb4?space=5c50512a4f0c436195b9ad67
tif_url = "vignettes/rgb_geotiff_L1_ua-mac_2018-05-04__13-04-09-888_left.tif"

rgb_raster_1 = raster(tif_url, band = 1)
rgb_raster_1_crop = crop(rgb_raster_1, extent(rgb_raster_1, 1500, 2500, 3000, 4000))
plot(rgb_raster_1_crop)
cellStats(rgb_raster_1_crop, stat = "mean")
hist(rgb_raster_1_crop)

rgb_raster_2 = raster(tif_url, band = 2)
rgb_raster_2_crop = crop(rgb_raster_2, extent(rgb_raster_2, 1500, 2500, 3000, 4000))
plot(rgb_raster_2_crop)
cellStats(rgb_raster_2_crop, stat = "mean")
hist(rgb_raster_2_crop)
```

```{r get_trait_data_2, message = FALSE}
trait2 <- betydb_query(table     = "search", 
                      trait     = "canopy_cover", 
                      date      = "~2018 May",
                      limit     =  "none")

trait2 = trait2 %>% 
  mutate(day = as.Date(raw_date))
```

## Calculate greenness metric for each image
```{r image_calculations}
add_rasters = rgb_raster_2_crop + rgb_raster_1_crop
numerator = cellStats(add_rasters, stat = "sum")

subtract_rasters = rgb_raster_2_crop - rgb_raster_1_crop
denominator = cellStats(subtract_rasters, stat = "sum")

greenness_df = data.frame(greenness = numerator / denominator, 
                          day = as.Date(str_extract(tif_url, "[0-9]{4}-[0-9]{2}-[0-9]{2}")))
```

## Combine with canopy cover and plot
```{r plot_sensor_trait}
trait2 = trait2 %>% 
  filter(day %in% greenness_df$day) %>% 
  group_by(day) %>% 
  summarise(mean_canopy_cover = mean(mean), 
            sd_canopy_cover = sd(mean))

sensor_trait_df = left_join(trait2, greenness_df, by = "day")

ggplot(sensor_trait_df, aes(x = mean_canopy_cover, y = greenness)) +
  geom_point()
```
