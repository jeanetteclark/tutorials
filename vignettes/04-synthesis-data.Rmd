# Combining trait, weather, and image datasets

The objective of this vignette is to join and plot the trait and weather data, and also the trait and image data. 

The first synthesis plot will be of the greenness from the image data against the canopy cover from the trait data. 
The second synthesis plot will be a histogram of the inflection points for each cultivar's growing degree days. 

## Get and join data
```{r synth_setup}
library(dplyr)
library(ggplot2)
library(jsonlite)
library(lubridate)
library(traits)
library(inflection)

options(betydb_url = "https://terraref.ncsa.illinois.edu/bety/",
        betydb_api_version = 'v1', 
        betydb_key = '9999999999999999999999999999999999999999')
```

```{r get_trait_data, message = FALSE}
trait <- betydb_query(table     = "search", 
                      trait     = "canopy_height", 
                      date      = "~2017",
                      limit     =  "none")

trait = trait %>% 
  mutate(day = as.Date(raw_date))
```

```{r, get_weather_data}
weather <- fromJSON('https://terraref.ncsa.illinois.edu/clowder/api/geostreams/datapoints?stream_id=46431&since=2017-01-01&until=2017-12-31', flatten = FALSE)

weather <- weather$properties %>% 
  mutate(time = ymd_hms(weather$end_time))

daily_values = weather %>% 
  mutate(day = as.Date(time), 
         air_temp_converted = air_temperature - 273.15) %>% 
  group_by(day) %>% 
  summarise(min_temp = min(air_temp_converted), 
            max_temp = max(air_temp_converted), 
            gdd = ifelse(sum(min_temp, max_temp) / 2 > 10, 
                         (max_temp + min_temp) / 2 - 10, 0))

daily_values = daily_values %>% 
  mutate(gdd_cum = cumsum(gdd))
```

```{r, combine_trait_weather}
trait_weather_df = full_join(trait, daily_values, by = "day")
trait_weather_df = trait_weather_df %>% 
  select(day, cultivar, mean, gdd_cum) %>% 
  na.omit()
```

## Plot and model relationship between GDD and canopy cover for each cultivar
```{r, model_get_parameters}
single_cultivar = trait_weather_df %>% 
  filter(cultivar == "PI656026")

cap = 120
initial = 25
mean = single_cultivar$mean[57]
gdd_cum = single_cultivar$gdd_cum[57]
rate = ((log((cap/mean) - 1)) - initial)/gdd_cum

model_single_cultivar = nls(mean ~ cap / (1 + exp(initial + rate * gdd_cum)), 
                            start = list(cap = 120, initial = 25, rate = rate),
                            data = single_cultivar, trace = TRUE)

single_cultivar = single_cultivar %>% 
  mutate(mean_predict = coef(model_single_cultivar)[1] / (1 + exp(coef(model_single_cultivar)[2] + coef(model_single_cultivar)[3] * gdd_cum)))
```

```{r, model_all_cultivars}
all_cultivars = c(day = as.double(), cultivar = as.character(), mean = as.numeric(), 
                  gdd_cum = as.numeric(), mean_predict = as.numeric())
for(each_cultivar in unique(trait_weather_df$cultivar)){
  each_cultivar_df = filter(trait_weather_df, cultivar == each_cultivar)
  each_cultivar_model = nls(mean ~ cap / (1 + exp(initial + rate * gdd_cum)), 
                            start = list(cap = 120, initial = 25, rate = rate),
                            data = each_cultivar_df)
  each_cultivar_df = each_cultivar_df %>% 
      mutate(mean_predict = coef(each_cultivar_model)[1] / (1 + exp(coef(each_cultivar_model)[2] + coef(each_cultivar_model)[3] * gdd_cum)))
  all_cultivars = rbind(each_cultivar_df, all_cultivars)
}

ggplot(all_cultivars) +
  geom_point(aes(x = gdd_cum, y = mean)) +
  geom_line(aes(x = gdd_cum, y = mean_predict), color = "orange") +
  facet_wrap(~cultivar, scales = "free_y") +
  labs(x = "Cumulative growing degree days", y = "Canopy Height")
```

## Create histogram of growth rate for all cultivars
```{r, calculate_inflections}
inflection_points = c(cultivar = as.character(), value = as.numeric())
for(each_cultivar in unique(all_cultivars$cultivar)){
  each_cultivar_df = filter(all_cultivars, cultivar == each_cultivar)
  each_cultivar_inf = ede(each_cultivar_df$gdd_cum, each_cultivar_df$mean_predict, 0)
  each_cultivar_df = data.frame(cultivar = each_cultivar, inf_value = each_cultivar_inf[3])
  inflection_points = rbind(each_cultivar_df, inflection_points)
}

all_cultivars = left_join(all_cultivars, inflection_points, by = "cultivar")
```

```{r, plot_inflections}
ggplot(all_cultivars) +
  geom_point(aes(x = gdd_cum, y = mean)) +
  geom_line(aes(x = gdd_cum, y = mean_predict), color = "orange") +
  geom_vline(aes(xintercept = inf_value)) +
  facet_wrap(~cultivar, scales = "free_y") +
  labs(x = "Cumulative growing degree days", y = "Canopy Height")

ggplot(inflection_points, aes(x = inf_value)) +
  geom_histogram() +
  xlim(min(all_cultivars$gdd_cum), max(all_cultivars$gdd_cum)) +
  labs(x = "Inflection points", y = "Number")
```

## Calculate greenness metric for each image


## Combine with canopy cover and plot

